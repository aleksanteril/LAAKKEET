@startuml Minimum State Machine

[*] --> STANDBY
STANDBY : eEnter / reset_machine_struct(&m);
STANDBY : eTick / led_toggle();
STANDBY : eExit / led_off();
STANDBY --> CHECK_CALIBRATION : eKey(SW0) / calibrate();


note "- struct Machine, jossa pill_count, \n sun muut yleiset tiedot stateille. \n \n - Olkoon 1 tick aluksi 50ms." as N1
note left of STANDBY : When the dispenser is started \n it waits for a button to be pressed \n and blinks an LED while waiting.

CHECK_CALIBRATION : eEnter /
CHECK_CALIBRATION : eTick / check_calib();
CHECK_CALIBRATION : eExit /
CHECK_CALIBRATION --> STANDBY : eTick [calibrated == false] /
CHECK_CALIBRATION --> CALIBRATED : eTick [calibrated == true] /

note left of CHECK_CALIBRATION : When the button is pressed the dispenser \n is calibrated by turning the wheel \n at least one full turn and then stopping \n the wheel so that the compartment with \n the sensor opening is aligned with the drop tube.

CALIBRATED : eEnter / led_on();
CALIBRATED : eTick /
CALIBRATED : eExit / led_off();
CALIBRATED --> DISPENSE_WAIT : eKey(SW1) /

note left of CALIBRATED : After calibration the program keeps \n the LED on until user presses another button.

DISPENSE_WAIT : eEnter / timer = 0;
DISPENSE_WAIT : eTick / ++timer;
DISPENSE_WAIT : eExit / ++pill_count;
DISPENSE_WAIT --> DISPENSE_PILL : eTick [timer >= 600] / dispense();
DISPENSE_WAIT --> STANDBY : eEnter [m->pill_count >= 7] /

note left of DISPENSE_WAIT : Then it dispenses pills every \n 30 seconds starting from the button press.
note right of DISPENSE_WAIT : When all pills have been dispensed \n (wheel turned 7 times) \n the program starts over.

DISPENSE_PILL : eEnter / timer = 0;
DISPENSE_PILL : eTick / ++timer;
DISPENSE_PILL : eExit /
DISPENSE_PILL --> DISPENSE_WAIT : eKey(PIEZO_SENS) / 
DISPENSE_PILL --> DISPENSE_FAIL : eTick [timer >= 4] /

note left of DISPENSE_PILL : When the wheel is turned, \n the piezo sensor is used to detect \n if a pill was dispensed or not.

DISPENSE_FAIL : eEnter / log_error(), count = 0;
DISPENSE_FAIL : eTick / led_toggle(), ++count;
DISPENSE_FAIL : eExit / 
DISPENSE_FAIL --> DISPENSE_WAIT : eTick [count >= 10] / led_off();

note left of DISPENSE_FAIL : If no pill was detected (200ms) the LED blinks 5 times.

@enduml
